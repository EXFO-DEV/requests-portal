<?php
session_start();

// Configuration de la base de données
class Database {
    private static $instance = null;
    private $connection;
    
    private function __construct() {
        try {
            $this->connection = new PDO(
                'mysql:host=localhost;dbname=support_portal;charset=utf8mb4',
                'username',
                'password',
                [PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION]
            );
        } catch(PDOException $e) {
            error_log("Database connection failed: " . $e->getMessage());
            die("Erreur de connexion à la base de données");
        }
    }
    
    public static function getInstance() {
        if (self::$instance === null) {
            self::$instance = new Database();
        }
        return self::$instance;
    }
    
    public function getConnection() {
        return $this->connection;
    }
}

// Classe pour la gestion des tickets
class TicketManager {
    private $db;
    
    public function __construct() {
        $this->db = Database::getInstance()->getConnection();
    }
    
    public function createTicket($data) {
        $sql = "INSERT INTO tickets (
            ticket_id, user_email, employee_name, employee_title, 
            request_subject, service, sub_category, system_impacted, 
            observed_issue, is_urgent, urgent_details, status, created_at
        ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, 'open', NOW())";
        
        $stmt = $this->db->prepare($sql);
        $ticketId = $this->generateTicketId();
        
        return $stmt->execute([
            $ticketId, $data['email'], $data['name'], $data['employee_title'],
            $data['request_subject'], $data['service'], $data['sub_category'] ?? '',
            $data['system_impacted'], $data['observed_issue'], 
            $data['urgent'] === 'yes' ? 1 : 0, $data['urgent_details'] ?? ''
        ]) ? $ticketId : false;
    }
    
    public function getUserTickets($email) {
        $sql = "SELECT * FROM tickets WHERE user_email = ? ORDER BY created_at DESC";
        $stmt = $this->db->prepare($sql);
        $stmt->execute([$email]);
        return $stmt->fetchAll(PDO::FETCH_ASSOC);
    }
    
    private function generateTicketId() {
        return 'TKT-' . date('Ymd') . '-' . substr(uniqid(), -6);
    }
}

// Classe pour l'authentification (simulation AD)
class AuthManager {
    public static function getCurrentUser() {
        // Simulation - à remplacer par la vraie logique AD
        if (!isset($_SESSION['user'])) {
            $_SESSION['user'] = [
                'email' => 'user@exfo.com',
                'name' => 'Jean Dupont',
                'department' => 'IT'
            ];
        }
        return $_SESSION['user'];
    }
    
    public static function generateCSRFToken() {
        if (!isset($_SESSION['csrf_token'])) {
            $_SESSION['csrf_token'] = bin2hex(random_bytes(32));
        }
        return $_SESSION['csrf_token'];
    }
    
    public static function verifyCSRFToken($token) {
        return isset($_SESSION['csrf_token']) && hash_equals($_SESSION['csrf_token'], $token);
    }
}

// Classe pour les notifications
class NotificationManager {
    private $serviceMapping = [
        'helpdesk' => [
            'email' => 'itsupport_exfo@kanbanize.com',
            'name' => 'Helpdesk TI'
        ],
        'tsp' => [
            'email' => 'tspqc_exfo@kanbanize.com',
            'name' => 'TSP'
        ],
        'npi' => [
            'email' => 'npiqc_exfo@kanbanize.com',
            'name' => 'NPI'
        ]
    ];
    
    public function sendTicketNotification($ticketId, $ticketData) {
        $service = $this->serviceMapping[$ticketData['service']] ?? null;
        if (!$service) return false;
        
        $subject = "[{$ticketId}] Nouvelle demande: " . $ticketData['request_subject'];
        $body = $this->formatEmailBody($ticketId, $ticketData);
        
        // Utilisation de mail() - à remplacer par une solution plus robuste (PHPMailer, etc.)
        return mail($service['email'], $subject, $body, $this->getEmailHeaders());
    }
    
    private function formatEmailBody($ticketId, $data) {
        $urgentFlag = $data['urgent'] === 'yes' ? "⚠️ URGENT ⚠️" : "";
        
        return "
=================================
       NOUVEAU TICKET SUPPORT       
=================================

Ticket ID: {$ticketId}
{$urgentFlag}

Employé: {$data['name']} ({$data['employee_title']})
Email: {$data['email']}

Objet: {$data['request_subject']}
Service: {$data['service']}
Type: " . ($data['sub_category'] ?? 'N/A') . "

Système impacté: {$data['system_impacted']}
Problème observé: {$data['observed_issue']}

" . ($data['urgent'] === 'yes' ? "DÉTAILS URGENCE: {$data['urgent_details']}\n" : "") . "

Accéder au ticket: " . $_SERVER['HTTP_HOST'] . "/view_ticket.php?id={$ticketId}
        ";
    }
    
    private function getEmailHeaders() {
        return "From: no-reply@exfo.com\r\n" .
               "Reply-To: no-reply@exfo.com\r\n" .
               "Content-Type: text/plain; charset=UTF-8\r\n";
    }
}

// Traitement du formulaire
$message = '';
$messageType = '';
$user = AuthManager::getCurrentUser();

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    try {
        // Vérification CSRF
        if (!AuthManager::verifyCSRFToken($_POST['csrf_token'] ?? '')) {
            throw new Exception('Token de sécurité invalide');
        }
        
        // Validation et nettoyage des données
        $requiredFields = ['name', 'employee_title', 'request_subject', 'service', 'system_impacted', 'observed_issue'];
        foreach ($requiredFields as $field) {
            if (empty($_POST[$field])) {
                throw new Exception("Le champ {$field} est requis");
            }
        }
        
        $cleanData = [];
        foreach ($_POST as $key => $value) {
            $cleanData[$key] = htmlspecialchars(trim($value), ENT_QUOTES, 'UTF-8');
        }
        $cleanData['email'] = $user['email'];
        
        // Création du ticket
        $ticketManager = new TicketManager();
        $ticketId = $ticketManager->createTicket($cleanData);
        
        if ($ticketId) {
            // Envoi de notification
            $notificationManager = new NotificationManager();
            $notificationManager->sendTicketNotification($ticketId, $cleanData);
            
            $message = "Votre demande a été créée avec succès. Numéro de ticket: <strong>{$ticketId}</strong>";
            $messageType = 'success';
            
            // Reset du token CSRF
            unset($_SESSION['csrf_token']);
        } else {
            throw new Exception('Erreur lors de la création du ticket');
        }
        
    } catch (Exception $e) {
        $message = $e->getMessage();
        $messageType = 'danger';
        error_log("Ticket creation error: " . $e->getMessage());
    }
}

// Récupération de l'historique des tickets
$ticketManager = new TicketManager();
$userTickets = $ticketManager->getUserTickets($user['email']);
?>
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Portail des demandes de support - EXFO</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        :root {
            --primary-color: #0d6efd;
            --secondary-color: #6c757d;
            --success-color: #198754;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .main-container {
            padding: 2rem 0;
        }
        
        .card {
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border: none;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            background: rgba(255,255,255,0.95);
        }
        
        .card-header {
            background: linear-gradient(135deg, var(--primary-color), #4dabf7);
            border-radius: 15px 15px 0 0 !important;
            padding: 1.5rem;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), #4dabf7);
            border: none;
            border-radius: 25px;
            padding: 0.7rem 2rem;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(13,110,253,0.4);
        }
        
        .form-control, .form-select {
            border-radius: 10px;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(13,110,253,0.25);
        }
        
        .alert {
            border-radius: 10px;
            border: none;
        }
        
        .table {
            border-radius: 10px;
            overflow: hidden;
        }
        
        .badge {
            border-radius: 20px;
            padding: 0.5rem 1rem;
        }
        
        .tab-content {
            padding: 2rem 0;
        }
        
        .nav-tabs .nav-link {
            border-radius: 10px 10px 0 0;
            border: none;
            margin-right: 0.5rem;
        }
        
        .nav-tabs .nav-link.active {
            background: var(--primary-color);
            color: white;
        }
        
        .auto-save-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }
        
        @media (max-width: 768px) {
            .main-container {
                padding: 1rem;
            }
            
            .card {
                margin: 0.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="container main-container">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12 text-center">
                <h1 class="text-white mb-3">
                    <i class="bi bi-headset"></i> Portail Support EXFO
                </h1>
                <p class="text-white-50">Bienvenue <?php echo htmlspecialchars($user['name']); ?></p>
            </div>
        </div>
        
        <!-- Auto-save indicator -->
        <div id="autoSaveIndicator" class="auto-save-indicator" style="display: none;">
            <div class="alert alert-info alert-sm">
                <i class="bi bi-cloud-arrow-up"></i> Sauvegarde automatique...
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="row">
            <div class="col-12">
                <!-- Tabs -->
                <ul class="nav nav-tabs" id="mainTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="new-request-tab" data-bs-toggle="tab" 
                                data-bs-target="#new-request" type="button" role="tab">
                            <i class="bi bi-plus-circle"></i> Nouvelle demande
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="my-tickets-tab" data-bs-toggle="tab" 
                                data-bs-target="#my-tickets" type="button" role="tab">
                            <i class="bi bi-list-ul"></i> Mes demandes (<?php echo count($userTickets); ?>)
                        </button>
                    </li>
                </ul>
                
                <div class="tab-content" id="mainTabsContent">
                    <!-- New Request Tab -->
                    <div class="tab-pane fade show active" id="new-request" role="tabpanel">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="text-white mb-0">
                                    <i class="bi bi-plus-circle"></i> Créer une nouvelle demande
                                </h3>
                            </div>
                            <div class="card-body">
                                <?php if ($message): ?>
                                    <div class="alert alert-<?php echo $messageType; ?> alert-dismissible fade show" role="alert">
                                        <i class="bi bi-<?php echo $messageType === 'success' ? 'check-circle' : 'exclamation-triangle'; ?>"></i>
                                        <?php echo $message; ?>
                                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                    </div>
                                <?php endif; ?>
                                
                                <form id="supportForm" method="POST" novalidate>
                                    <input type="hidden" name="csrf_token" value="<?php echo AuthManager::generateCSRFToken(); ?>">
                                    
                                    <div class="row">
                                        <!-- Informations employé -->
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="name" class="form-label">
                                                    <i class="bi bi-person"></i> Nom de l'employé *
                                                </label>
                                                <input type="text" class="form-control" id="name" name="name" 
                                                       value="<?php echo htmlspecialchars($user['name']); ?>" required>
                                                <div class="invalid-feedback">Ce champ est requis</div>
                                            </div>
                                        </div>
                                        
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="employee_title" class="form-label">
                                                    <i class="bi bi-briefcase"></i> Titre d'emploi *
                                                </label>
                                                <input type="text" class="form-control" id="employee_title" 
                                                       name="employee_title" required>
                                                <div class="invalid-feedback">Ce champ est requis</div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Objet de la demande -->
                                    <div class="mb-3">
                                        <label for="request_subject" class="form-label">
                                            <i class="bi bi-chat-text"></i> Objet de la demande *
                                        </label>
                                        <input type="text" class="form-control" id="request_subject" 
                                               name="request_subject" required>
                                        <div class="invalid-feedback">Ce champ est requis</div>
                                    </div>
                                    
                                    <!-- Service -->
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="service" class="form-label">
                                                    <i class="bi bi-gear"></i> Service *
                                                </label>
                                                <select class="form-select" id="service" name="service" required>
                                                    <option value="">Sélectionnez un service</option>
                                                    <option value="helpdesk">🖥️ Demandes TI Helpdesk</option>
                                                    <option value="tsp">🔧 Demandes TSP</option>
                                                    <option value="npi">📋 Demandes NPI</option>
                                                    <option value="master">📊 Données maîtres</option>
                                                </select>
                                                <div class="invalid-feedback">Veuillez sélectionner un service</div>
                                            </div>
                                        </div>
                                        
                                        <div class="col-md-6">
                                            <div class="mb-3" id="subCategoryGroup" style="display:none;">
                                                <label for="subCategory" class="form-label">
                                                    <i class="bi bi-tags"></i> Type de demande
                                                </label>
                                                <select class="form-select" id="subCategory" name="sub_category">
                                                    <!-- Options dynamiques -->
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Champs détaillés -->
                                    <div id="additionalFields" style="display:none;">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="system_impacted" class="form-label">
                                                        <i class="bi bi-cpu"></i> Système impacté *
                                                    </label>
                                                    <input type="text" class="form-control" id="system_impacted" 
                                                           name="system_impacted" required>
                                                    <div class="invalid-feedback">Ce champ est requis</div>
                                                </div>
                                            </div>
                                            
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="urgent" class="form-label">
                                                        <i class="bi bi-exclamation-triangle"></i> Demande urgente ?
                                                    </label>
                                                    <select class="form-select" id="urgent" name="urgent">
                                                        <option value="no" selected>Non</option>
                                                        <option value="yes">Oui</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="observed_issue" class="form-label">
                                                <i class="bi bi-bug"></i> Problème observé *
                                            </label>
                                            <textarea class="form-control" id="observed_issue" name="observed_issue" 
                                                      rows="4" required placeholder="Décrivez le problème en détail..."></textarea>
                                            <div class="invalid-feedback">Ce champ est requis</div>
                                        </div>
                                        
                                        <div class="mb-3" id="urgentDetailsGroup" style="display:none;">
                                            <label for="urgent_details" class="form-label">
                                                <i class="bi bi-clock"></i> Détails sur l'urgence
                                            </label>
                                            <textarea class="form-control" id="urgent_details" name="urgent_details" 
                                                      rows="3" placeholder="Expliquez pourquoi cette demande est urgente..."></textarea>
                                        </div>
                                    </div>
                                    
                                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                        <button type="button" class="btn btn-outline-secondary me-md-2" onclick="resetForm()">
                                            <i class="bi bi-arrow-clockwise"></i> Réinitialiser
                                        </button>
                                        <button type="submit" class="btn btn-primary">
                                            <i class="bi bi-send"></i> Soumettre la demande
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    
                    <!-- My Tickets Tab -->
                    <div class="tab-pane fade" id="my-tickets" role="tabpanel">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="text-white mb-0">
                                    <i class="bi bi-list-ul"></i> Mes demandes de support
                                </h3>
                            </div>
                            <div class="card-body">
                                <?php if (empty($userTickets)): ?>
                                    <div class="text-center py-5">
                                        <i class="bi bi-inbox display-1 text-muted"></i>
                                        <h4 class="text-muted mt-3">Aucune demande trouvée</h4>
                                        <p class="text-muted">Vous n'avez pas encore créé de demande de support.</p>
                                    </div>
                                <?php else: ?>
                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead class="table-dark">
                                                <tr>
                                                    <th>Ticket ID</th>
                                                    <th>Objet</th>
                                                    <th>Service</th>
                                                    <th>Statut</th>
                                                    <th>Urgence</th>
                                                    <th>Créé le</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <?php foreach ($userTickets as $ticket): ?>
                                                    <tr>
                                                        <td>
                                                            <strong><?php echo htmlspecialchars($ticket['ticket_id']); ?></strong>
                                                        </td>
                                                        <td><?php echo htmlspecialchars($ticket['request_subject']); ?></td>
                                                        <td>
                                                            <span class="badge bg-info">
                                                                <?php echo htmlspecialchars($ticket['service']); ?>
                                                            </span>
                                                        </td>
                                                        <td>
                                                            <?php
                                                            $statusClass = match($ticket['status']) {
                                                                'open' => 'bg-warning',
                                                                'in_progress' => 'bg-primary', 
                                                                'resolved' => 'bg-success',
                                                                'closed' => 'bg-secondary',
                                                                default => 'bg-light text-dark'
                                                            };
                                                            $statusText = match($ticket['status']) {
                                                                'open' => 'Ouvert',
                                                                'in_progress' => 'En cours',
                                                                'resolved' => 'Résolu',
                                                                'closed' => 'Fermé',
                                                                default => $ticket['status']
                                                            };
                                                            ?>
                                                            <span class="badge <?php echo $statusClass; ?>">
                                                                <?php echo $statusText; ?>
                                                            </span>
                                                        </td>
                                                        <td>
                                                            <?php if ($ticket['is_urgent']): ?>
                                                                <span class="badge bg-danger">
                                                                    <i class="bi bi-exclamation-triangle"></i> Urgent
                                                                </span>
                                                            <?php else: ?>
                                                                <span class="badge bg-light text-dark">Normal</span>
                                                            <?php endif; ?>
                                                        </td>
                                                        <td><?php echo date('d/m/Y H:i', strtotime($ticket['created_at'])); ?></td>
                                                    </tr>
                                                <?php endforeach; ?>
                                            </tbody>
                                        </table>
                                    </div>
                                <?php endif; ?>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Configuration des services et types
        const categoryMapping = {
            helpdesk: {
                email: "itsupport_exfo@kanbanize.com",
                options: ["Déclarer un incident", "Demande d'accès", "Préparation d'événement", "Autres demandes"]
            },
            tsp: {
                email: "tspqc_exfo@kanbanize.com",
                options: ["Demande de support Production / Centres de Services", "Demande d'assistance projet"]
            },
            npi: {
                email: "npiqc_exfo@kanbanize.com",
                options: ["Autres demandes", "Doc de Prod / BOM", "Routing/Équipement/Layout"]
            },
            master: {
                email: "",
                options: []
            }
        };
        
        // Auto-save functionality
        let autoSaveTimeout;
        const AUTOSAVE_DELAY = 2000; // 2 secondes
        
        function autoSave() {
            clearTimeout(autoSaveTimeout);
            autoSaveTimeout = setTimeout(() => {
                const formData = new FormData(document.getElementById('supportForm'));
                const data = Object.fromEntries(formData);
                
                // Exclure le token CSRF de la sauvegarde
                delete data.csrf_token;
                
                localStorage.setItem('draft_request', JSON.stringify(data));
                showAutoSaveIndicator();
            }, AUTOSAVE_DELAY);
        }
        
        function showAutoSaveIndicator() {
            const indicator = document.getElementById('autoSaveIndicator');
            indicator.style.display = 'block';
            setTimeout(() => {
                indicator.style.display = 'none';
            }, 2000);
        }
        
        function loadDraft() {
            const draft = localStorage.getItem('draft_request');
            if (draft) {
                try {
                    const data = JSON.parse(draft);
                    Object.entries(data).forEach(([key, value]) => {
                        const element = document.getElementById(key);
                        if (element) {
                            element.value = value;
                            if (element.type === 'select-one') {
                                element.dispatchEvent(new Event('change'));
                            }
                        }
                    });
                } catch (e) {
                    console.error('Erreur lors du chargement du brouillon:', e);
                }
            }
        }
        
        // Gestion dynamique du formulaire
        function updateSubCategory() {
            const service = document.getElementById('service').value;
            const group = document.getElementById('subCategoryGroup');
            const select = document.getElementById('subCategory');
            
            select.innerHTML = "";
            
            if (service && categoryMapping[service].options.length) {
                group.style.display = "block";
                
                const defaultOption = document.createElement("option");
                defaultOption.value = "";
                defaultOption.text = "Sélectionnez le type de demande";
                select.appendChild(defaultOption);
                
                categoryMapping[service].options.forEach(option => {
                    const opt = document.createElement("option");
                    opt.value = option;
                    opt.text = option;
                    select.appendChild(opt);
                });
            } else {
                group.style.display = "none";
            }
            
            updateAdditionalFieldsVisibility();
        }
        
        function updateAdditionalFieldsVisibility() {
            const service = document.getElementById('service').value;
            const additionalFields = document.getElementById('additionalFields');
            
            if (!service) {
                additionalFields.style.display = "none";
                return;
            }
            
            if (categoryMapping[service].options.length) {
                const subCategory = document.getElementById('subCategory').value;
                additionalFields.style.display = subCategory ? "block" : "none";
            } else {
                additionalFields.style.display = "block";
            }
        }
        
        function updateUrgencyDetailsVisibility() {
            const urgent = document.getElementById('urgent').value;
            const urgentDetailsGroup = document.getElementById('urgentDetailsGroup');
            urgentDetailsGroup.style.display = urgent === "yes" ? "block" : "none";
        }
        
        function resetForm() {
            document.getElementById('supportForm').reset();
            document.getElementById('subCategoryGroup').style.display = "none";
            document.getElementById('additionalFields').style.display = "none";
            document.getElementById('urgentDetailsGroup').style.display = "none";
            localStorage.removeItem('draft_request');
        }
        
        // Validation du formulaire
        function validateForm() {
            const form = document.getElementById('supportForm');
            const isValid = form.checkValidity();
            
            if (!isValid) {
                form.classList.add('was-validated');
                return false;
            }
